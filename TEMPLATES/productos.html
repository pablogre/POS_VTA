<!-- templates/productos.html -->
{% extends "base.html" %}

{% block title %}Productos - POS Argentina{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-box"></i> Gesti√≥n de Productos</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="limpiarFormProducto()">
        <i class="fas fa-plus"></i> Nuevo Producto
    </button>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Buscar productos</label>
                <input type="text" class="form-control" id="buscarProducto" placeholder="C√≥digo o nombre...">
            </div>
            <div class="col-md-2">
                <label class="form-label">Categor√≠a</label>
                <select class="form-select" id="filtroCategoria">
                    <option value="">Todas las categor√≠as</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Stock</label>
                <select class="form-select" id="filtroStock">
                    <option value="">Todo el stock</option>
                    <option value="bajo">Stock bajo (< 10)</option>
                    <option value="sin_stock">Sin stock</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="aplicarFiltrosProductos()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de productos -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Listado de Productos</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tablaProductos">
                <thead class="table-dark">
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nombre</th>
                        <th>Categor√≠a</th>
                        <th>Costo</th>
                        <th>Margen %</th>
                        <th>Precio Venta</th>
                        <th>Stock</th>
                        <th>IVA %</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr>
                        <td><code>{{ producto.codigo }}</code></td>
                        <td>
                            <strong>{{ producto.nombre }}</strong>
                            {% if producto.es_combo %}
                                <br><span class="badge bg-warning text-dark">OFERTA</span>
                            {% endif %}
                            {% if producto.descripcion %}
                                <br><small class="text-muted">{{ producto.descripcion[:50] }}{% if producto.descripcion|length > 50 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ producto.categoria or 'Sin categor√≠a' }}</span>
                        </td>
                        <td class="text-end">
                            <small class="text-muted">$</small><strong>{{ "%.2f"|format(producto.costo or 0) }}</strong>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-warning text-dark">{{ "%.1f"|format(producto.margen or 0) }}%</span>
                        </td>
                        <td class="text-end">
                            <strong>${{ "%.2f"|format(producto.precio) }}</strong>
                            {% if producto.es_combo and producto.producto_base %}
                                {% set precio_normal = producto.producto_base.precio * producto.cantidad_combo %}
                                {% set descuento = ((precio_normal - producto.precio) / precio_normal * 100) %}
                                <br><small class="text-danger">-{{ "%.1f"|format(descuento) }}%</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if producto.stock <= 0 %}
                                <span class="badge bg-danger">{{ producto.stock }}</span>
                            {% elif producto.stock < 10 %}
                                <span class="badge bg-warning text-dark">{{ producto.stock }}</span>
                            {% else %}
                                <span class="badge bg-success">{{ producto.stock }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ "%.0f"|format(producto.iva) }}%</td>
                        <td>
                            {% if producto.activo %}
                                <span class="badge bg-success">Activo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if producto.es_combo %}
                                    <button class="btn btn-warning" onclick="editarCombo({{ producto.id }})" title="Editar Combo">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                {% else %}
                                    <button class="btn btn-warning" onclick="editarProducto({{ producto.id }})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                {% endif %}
                                <button class="btn btn-info" onclick="ajustarStock({{ producto.id }})" title="Ajustar Stock">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <button class="btn btn-{% if producto.activo %}danger{% else %}success{% endif %}" onclick="toggleProducto({{ producto.id }})" title="{% if producto.activo %}Desactivar{% else %}Activar{% endif %}">
                                    <i class="fas fa-power-off"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ===== SECCI√ìN DE GESTI√ìN DE COMBOS ===== -->
<div class="card mt-4">
    <div class="card-header bg-warning text-dark">
        <h5><i class="fas fa-tags"></i> Gesti√≥n de Combos y Ofertas</h5>
    </div>
    <div class="card-body">
        <!-- Botones de acci√≥n -->
        <div class="mb-3">
            <button type="button" class="btn btn-success" onclick="mostrarModalCrearCombo()">
                <i class="fas fa-plus"></i> Crear Nueva Oferta
            </button>
            <button type="button" class="btn btn-info" onclick="verTodosCombos()">
                <i class="fas fa-list"></i> Ver Todas las Ofertas
            </button>
        </div>
        
        <!-- Lista de combos existentes -->
        <div id="lista_productos_combos">
            <div class="table-responsive" id="tablaCombosContainer">
                <table class="table table-striped" id="tablaCombos">
                    <thead class="table-warning">
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Producto Base</th>
                            <th>Cantidad</th>
                            <th>Precio Normal</th>
                            <th>Precio Oferta</th>
                            <th>Descuento</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos %}
                            {% if producto.es_combo %}
                            <tr>
                                <td><code>{{ producto.codigo }}</code></td>
                                <td>{{ producto.nombre }}</td>
                                <td>
                                    {% if producto.producto_base %}
                                        <strong>{{ producto.producto_base.codigo }}</strong><br>
                                        <small class="text-muted">{{ producto.producto_base.nombre }}</small>
                                    {% else %}
                                        <span class="text-muted">Sin base</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ producto.cantidad_combo }}x</span>
                                </td>
                                <td class="text-end">
                                    {% if producto.producto_base %}
                                        {% set precio_normal = producto.producto_base.precio * producto.cantidad_combo %}
                                        <span class="text-muted">${{ "%.2f"|format(precio_normal) }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <strong class="text-success">${{ "%.2f"|format(producto.precio) }}</strong>
                                </td>
                                <td class="text-center">
                                    {% if producto.producto_base %}
                                        {% set precio_normal = producto.producto_base.precio * producto.cantidad_combo %}
                                        {% set descuento = ((precio_normal - producto.precio) / precio_normal * 100) %}
                                        <span class="badge bg-danger">-{{ "%.1f"|format(descuento) }}%</span>
                                        <br><small class="text-success">Ahorro: ${{ "%.0f"|format(precio_normal - producto.precio) }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if producto.activo %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-warning" onclick="editarCombo({{ producto.id }})" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-info" onclick="ajustarStock({{ producto.id }})" title="Ajustar Stock">
                                            <i class="fas fa-boxes"></i>
                                        </button>
                                        <button class="btn btn-{% if producto.activo %}danger{% else %}success{% endif %}" onclick="toggleProducto({{ producto.id }})" title="{% if producto.activo %}Desactivar{% else %}Activar{% endif %}">
                                            <i class="fas fa-power-off"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Mensaje cuando no hay combos -->
            <div id="mensaje_sin_combos" class="text-center text-muted py-4">
                <i class="fas fa-tags fa-3x mb-3 opacity-50"></i>
                <h5>No hay combos/ofertas creados</h5>
                <p>Usa el bot√≥n "Crear Nueva Oferta" para crear tu primera oferta</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Producto -->
<div class="modal fade" id="modalProducto" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tituloModal">
                    <i class="fas fa-plus"></i> Nuevo Producto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formProducto">
                    <input type="hidden" id="productoId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="codigo" class="form-label">C√≥digo *</label>
                                <input type="text" class="form-control" id="codigo" required>
                                <div class="form-text">C√≥digo √∫nico del producto</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria" class="form-label">Categor√≠a</label>
                                <input type="text" class="form-control" id="categoria" list="categorias">
                                <datalist id="categorias">
                                    <!-- Se cargar√°n din√°micamente -->
                                </datalist>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="descripcion" rows="3"></textarea>
                    </div>
                    
                    <!-- Costos y Precios -->
                    <div class="card mb-3 bg-light">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-calculator"></i> Costos y Precios</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="costo" class="form-label">Precio de Costo *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="costo" step="0.01" min="0.01" required>
                                        </div>
                                        <small class="form-text text-muted">Costo sin IVA</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="margen" class="form-label">Margen de Ganancia %</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="margen" step="0.1" min="0" value="30">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <small class="form-text text-muted">Porcentaje sobre el costo</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="precio" class="form-label">Precio de Venta</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control bg-warning" id="precio" step="0.01" readonly>
                                        </div>
                                        <small class="form-text text-primary"><strong>Calculado autom√°ticamente</strong></small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Indicador visual del c√°lculo -->
                            <div class="alert alert-info mb-0" id="calculoInfo">
                                <i class="fas fa-info-circle"></i> 
                                <strong>C√°lculo:</strong> Precio = Costo √ó (1 + Margen/100)
                                <br>
                                <span id="formulaEjemplo">Ejemplo: $0.00 √ó (1 + 0%/100) = $0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4" id="stockInicialContainer">
                            <div class="mb-3">
                                <label for="stock" class="form-label">Stock Inicial</label>
                                <input type="number" class="form-control" id="stock" value="0" min="0">
                                <small class="form-text text-muted">Solo para productos nuevos</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="iva" class="form-label">IVA %</label>
                                <select class="form-select" id="iva">
                                    <option value="0">0% (Exento)</option>
                                    <option value="10.5">10.5%</option>
                                    <option value="21" selected>21%</option>
                                    <option value="27">27%</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="activo" checked>
                                <label class="form-check-label" for="activo">
                                    Producto activo
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarProducto()">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajustar Stock -->
<div class="modal fade" id="modalStock" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-boxes"></i> Ajustar Stock
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="infoProductoStock"></div>
                <form id="formStock">
                    <input type="hidden" id="stockProductoId">
                    <div class="mb-3">
                        <label for="tipoMovimiento" class="form-label">Tipo de movimiento</label>
                        <select class="form-select" id="tipoMovimiento">
                            <option value="entrada">Entrada (Agregar stock)</option>
                            <option value="salida">Salida (Quitar stock)</option>
                            <option value="ajuste">Ajuste (Establecer cantidad exacta)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadStock" class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="cantidadStock" min="0" required>
                        <div class="form-text" id="ayudaCantidad">Ingrese la cantidad a agregar</div>
                    </div>
                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivo" placeholder="Ej: Compra, Inventario, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info" onclick="guardarStock()">
                    <i class="fas fa-save"></i> Aplicar Cambio
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Variables globales
let productoActual = null;
let stockActual = 0;
let productosBase = [];

// ===== FUNCIONES PARA PRODUCTOS =====

// Funci√≥n para calcular precio autom√°ticamente
function calcularPrecio() {
    const costo = parseFloat(document.getElementById('costo').value) || 0;
    const margen = parseFloat(document.getElementById('margen').value) || 0;
    
    // F√≥rmula: precio = costo * (1 + (margen/100))
    const precio = costo * (1 + (margen / 100));
    
    // Actualizar campo precio
    document.getElementById('precio').value = precio.toFixed(2);
    
    // Actualizar ejemplo visual
    const formulaEjemplo = document.getElementById('formulaEjemplo');
    if (formulaEjemplo) {
        formulaEjemplo.textContent = `Ejemplo: $${costo.toFixed(2)} √ó (1 + ${margen}%/100) = $${precio.toFixed(2)}`;
    }
    
    console.log(`üí∞ Precio calculado: Costo=$${costo.toFixed(2)}, Margen=${margen}%, Precio=$${precio.toFixed(2)}`);
}

// Funci√≥n para limpiar el formulario
function limpiarFormProducto() {
    document.getElementById('formProducto').reset();
    document.getElementById('productoId').value = '';
    document.getElementById('tituloModal').innerHTML = '<i class="fas fa-plus"></i> Nuevo Producto';
    document.getElementById('stock').value = '0';
    document.getElementById('iva').value = '21';
    document.getElementById('activo').checked = true;
    
    // Valores por defecto para costo y margen
    document.getElementById('costo').value = '';
    document.getElementById('margen').value = '30';
    document.getElementById('precio').value = '0.00';
    
    productoActual = null;
    
    // Mostrar campo de stock inicial solo para productos nuevos
    document.getElementById('stockInicialContainer').style.display = 'block';
    
    // Limpiar validaciones
    const inputs = document.querySelectorAll('#formProducto input, #formProducto select, #formProducto textarea');
    inputs.forEach(input => {
        input.setCustomValidity('');
        input.classList.remove('is-invalid', 'is-valid');
    });
    
    // Calcular precio inicial
    calcularPrecio();
}

// Funci√≥n para cargar datos de producto en el formulario
function cargarProductoEnFormulario(producto) {
    document.getElementById('productoId').value = producto.id;
    document.getElementById('codigo').value = producto.codigo;
    document.getElementById('nombre').value = producto.nombre;
    document.getElementById('descripcion').value = producto.descripcion || '';
    document.getElementById('categoria').value = producto.categoria || '';
    document.getElementById('iva').value = producto.iva;
    document.getElementById('activo').checked = producto.activo;
    
    // Cargar costo y margen
    document.getElementById('costo').value = producto.costo || 0;
    document.getElementById('margen').value = producto.margen || 30;
    
    // El precio se calcular√° autom√°ticamente
    calcularPrecio();
    
    // Ocultar campo de stock inicial para edici√≥n
    document.getElementById('stockInicialContainer').style.display = 'none';
    
    document.getElementById('tituloModal').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
    productoActual = producto;
}

// Funci√≥n para editar producto
function editarProducto(id) {
    fetch(`/api/producto_detalle/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            cargarProductoEnFormulario(data);
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('modalProducto'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del producto');
        });
}

// Funci√≥n para guardar producto
function guardarProducto() {
    const form = document.getElementById('formProducto');
    
    // Validar formulario
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Validaciones adicionales
    const costo = parseFloat(document.getElementById('costo').value);
    const margen = parseFloat(document.getElementById('margen').value);
    
    if (costo <= 0) {
        alert('El costo debe ser mayor a 0');
        document.getElementById('costo').focus();
        return;
    }
    
    if (margen < 0) {
        alert('El margen no puede ser negativo');
        document.getElementById('margen').focus();
        return;
    }
    
    // Recalcular precio antes de enviar
    calcularPrecio();
    
    // Recopilar datos del formulario
    const formData = {
        id: document.getElementById('productoId').value || null,
        codigo: document.getElementById('codigo').value.trim().toUpperCase(),
        nombre: document.getElementById('nombre').value.trim(),
        descripcion: document.getElementById('descripcion').value.trim(),
        costo: costo,
        margen: margen,
        precio: parseFloat(document.getElementById('precio').value),
        categoria: document.getElementById('categoria').value.trim(),
        iva: parseFloat(document.getElementById('iva').value),
        activo: document.getElementById('activo').checked
    };
    
    // Solo incluir stock si es producto nuevo
    if (!formData.id) {
        formData.stock = parseInt(document.getElementById('stock').value) || 0;
    }
    
    // Validaciones adicionales
    if (!formData.codigo) {
        alert('El c√≥digo es obligatorio');
        document.getElementById('codigo').focus();
        return;
    }
    
    if (!formData.nombre) {
        alert('El nombre es obligatorio');
        document.getElementById('nombre').focus();
        return;
    }
    
    // Mostrar indicador de carga
    const btnGuardar = document.querySelector('#modalProducto .btn-primary');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    btnGuardar.disabled = true;
    
    // Enviar datos al servidor
    fetch('/guardar_producto', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalProducto'));
            modal.hide();
            
            // Recargar la p√°gina para mostrar los cambios
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi√≥n al guardar el producto');
    })
    .finally(() => {
        // Restaurar bot√≥n
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
}

// Funci√≥n para ajustar stock
function ajustarStock(id) {
    // Primero obtener informaci√≥n del producto
    fetch(`/api/producto_detalle/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            stockActual = data.stock;
            
            document.getElementById('stockProductoId').value = id;
            document.getElementById('infoProductoStock').innerHTML = `
                <div class="alert alert-info">
                    <strong>Producto:</strong> ${data.codigo} - ${data.nombre}<br>
                    <strong>Stock actual:</strong> <span class="badge bg-primary">${data.stock} unidades</span>
                </div>
            `;
            
            // Limpiar formulario
            document.getElementById('formStock').reset();
            document.getElementById('tipoMovimiento').value = 'entrada';
            document.getElementById('cantidadStock').min = '1';
            document.getElementById('ayudaCantidad').textContent = 'Ingrese la cantidad a agregar';
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalStock')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar informaci√≥n del producto');
        });
}

// Funci√≥n para guardar cambios de stock
function guardarStock() {
    const form = document.getElementById('formStock');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = {
        producto_id: document.getElementById('stockProductoId').value,
        tipo_movimiento: document.getElementById('tipoMovimiento').value,
        cantidad: parseInt(document.getElementById('cantidadStock').value),
        motivo: document.getElementById('motivo').value.trim()
    };
    
    // Validaciones adicionales
    if (formData.cantidad <= 0 && formData.tipo_movimiento !== 'ajuste') {
        alert('La cantidad debe ser mayor a 0');
        return;
    }
    
    if (formData.tipo_movimiento === 'ajuste' && formData.cantidad < 0) {
        alert('La cantidad para ajuste no puede ser negativa');
        return;
    }
    
    // Mostrar indicador de carga
    const btnGuardar = document.querySelector('#modalStock .btn-info');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    btnGuardar.disabled = true;
    
    // Enviar datos al servidor
    fetch('/ajustar_stock', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.message}\n\nStock anterior: ${data.stock_anterior}\nStock nuevo: ${data.stock_nuevo}`);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalStock'));
            modal.hide();
            
            // Recargar la p√°gina para mostrar los cambios
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi√≥n al ajustar stock');
    })
    .finally(() => {
        // Restaurar bot√≥n
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
}

// Funci√≥n para activar/desactivar producto
function toggleProducto(id) {
    if (confirm('¬øCambiar el estado del producto?')) {
        fetch(`/toggle_producto/${id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi√≥n al cambiar estado del producto');
        });
    }
}

// Funci√≥n para limpiar filtros
function limpiarFiltros() {
    document.getElementById('buscarProducto').value = '';
    document.getElementById('filtroCategoria').value = '';
    document.getElementById('filtroStock').value = '';
    aplicarFiltrosProductos();
}

// Funci√≥n para aplicar filtros
function aplicarFiltrosProductos() {
    const buscar = document.getElementById('buscarProducto').value.trim();
    const categoria = document.getElementById('filtroCategoria').value;
    const stock = document.getElementById('filtroStock').value;
    
    // Construir URL con par√°metros
    const params = new URLSearchParams();
    if (buscar) params.append('buscar', buscar);
    if (categoria) params.append('categoria', categoria);
    if (stock) params.append('stock', stock);
    
    fetch(`/buscar_productos_admin?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                actualizarTablaProductos(data.productos);
            } else {
                alert('Error en la b√∫squeda: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi√≥n en la b√∫squeda');
        });
}

// Funci√≥n para actualizar la tabla de productos
function actualizarTablaProductos(productos) {
    const tbody = document.querySelector('#tablaProductos tbody');
    
    if (productos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted">
                    <i class="fas fa-search"></i> No se encontraron productos
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = productos.map(producto => {
        const stockBadge = getStockBadge(producto.stock);
        const estadoBadge = producto.activo ? 
            '<span class="badge bg-success">Activo</span>' : 
            '<span class="badge bg-secondary">Inactivo</span>';
        
        const btnToggleClass = producto.activo ? 'btn-danger' : 'btn-success';
        const btnToggleTitle = producto.activo ? 'Desactivar' : 'Activar';
        
        // Calcular margen si no existe
        const costo = producto.costo || 0;
        const precio = producto.precio || 0;
        let margen = producto.margen || 0;
        
        // Si no hay margen guardado, calcularlo desde precio y costo
        if (!producto.margen && costo > 0) {
            margen = ((precio / costo) - 1) * 100;
        }
        
        const editFunction = producto.es_combo ? 'editarCombo' : 'editarProducto';
        
        return `
            <tr>
                <td><code>${producto.codigo}</code></td>
                <td>
                    <strong>${producto.nombre}</strong>
                    ${producto.es_combo ? '<br><span class="badge bg-warning text-dark">OFERTA</span>' : ''}
                    ${producto.descripcion ? 
                        `<br><small class="text-muted">${producto.descripcion.substring(0, 50)}${producto.descripcion.length > 50 ? '...' : ''}</small>` : 
                        ''
                    }
                </td>
                <td>
                    <span class="badge bg-info">${producto.categoria || 'Sin categor√≠a'}</span>
                </td>
                <td class="text-end">
                    <small class="text-muted">$</small><strong>${costo.toFixed(2)}</strong>
                </td>
                <td class="text-center">
                    <span class="badge bg-warning text-dark">${margen.toFixed(1)}%</span>
                </td>
                <td class="text-end">
                    <strong>${precio.toFixed(2)}</strong>
                </td>
                <td class="text-center">${stockBadge}</td>
                <td class="text-center">${Math.round(producto.iva)}%</td>
                <td>${estadoBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" onclick="${editFunction}(${producto.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info" onclick="ajustarStock(${producto.id})" title="Ajustar Stock">
                            <i class="fas fa-boxes"></i>
                        </button>
                        <button class="btn ${btnToggleClass}" onclick="toggleProducto(${producto.id})" title="${btnToggleTitle}">
                            <i class="fas fa-power-off"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Funci√≥n auxiliar para obtener el badge de stock
function getStockBadge(stock) {
    if (stock <= 0) {
        return `<span class="badge bg-danger">${stock}</span>`;
    } else if (stock < 10) {
        return `<span class="badge bg-warning text-dark">${stock}</span>`;
    } else {
        return `<span class="badge bg-success">${stock}</span>`;
    }
}

// Funci√≥n para cargar categor√≠as din√°micamente
function cargarCategorias() {
    fetch('/obtener_categorias')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar filtro de categor√≠as
                const filtroCategoria = document.getElementById('filtroCategoria');
                
                const nuevasOpciones = data.categorias.map(cat => 
                    `<option value="${cat}">${cat}</option>`
                ).join('');
                
                filtroCategoria.innerHTML = `<option value="">Todas las categor√≠as</option>${nuevasOpciones}`;
                
                // Actualizar datalist del formulario
                const datalist = document.getElementById('categorias');
                datalist.innerHTML = data.categorias.map(cat => 
                    `<option value="${cat}"></option>`
                ).join('');
            }
        })
        .catch(error => {
            console.error('Error cargando categor√≠as:', error);
        });
}



// ===== EVENT LISTENERS =====

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando p√°gina de productos...');
    
    // Cargar categor√≠as al inicio
    cargarCategorias();
    
    
    // Event listeners para c√°lculo autom√°tico de precio
    document.getElementById('costo').addEventListener('input', calcularPrecio);
    document.getElementById('margen').addEventListener('input', calcularPrecio);
    
    // Cambiar ayuda seg√∫n tipo de movimiento de stock
    document.getElementById('tipoMovimiento').addEventListener('change', function() {
        const tipo = this.value;
        const cantidadInput = document.getElementById('cantidadStock');
        const ayuda = document.getElementById('ayudaCantidad');
        
        switch(tipo) {
            case 'entrada':
                cantidadInput.min = '1';
                ayuda.textContent = 'Ingrese la cantidad a agregar';
                break;
            case 'salida':
                cantidadInput.min = '1';
                ayuda.textContent = `Ingrese la cantidad a quitar (m√°ximo: ${stockActual})`;
                break;
            case 'ajuste':
                cantidadInput.min = '0';
                ayuda.textContent = 'Ingrese la cantidad final que debe quedar';
                break;
        }
    });
    
    // B√∫squeda en tiempo real
    const inputBuscar = document.getElementById('buscarProducto');
    let timeoutBusqueda;
    
    inputBuscar.addEventListener('input', function() {
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(() => {
            aplicarFiltrosProductos();
        }, 500);
    });
    
    // Aplicar filtros cuando cambien los selects
    document.getElementById('filtroCategoria').addEventListener('change', aplicarFiltrosProductos);
    document.getElementById('filtroStock').addEventListener('change', aplicarFiltrosProductos);
    
    // Validar formulario en tiempo real
    const form = document.getElementById('formProducto');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.checkValidity()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
    
    // Convertir c√≥digo a may√∫sculas autom√°ticamente
    document.getElementById('codigo').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // Enviar formulario con Enter
    form.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            guardarProducto();
        }
    });
    
    // Validaci√≥n de c√≥digo √∫nico
    document.getElementById('codigo').addEventListener('blur', function() {
        const codigo = this.value.trim();
        const productoId = document.getElementById('productoId').value;
        
        if (codigo && (!productoId || !productoActual || productoActual.codigo !== codigo)) {
            // Verificar si el c√≥digo ya existe
            fetch(`/api/producto/${codigo}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        // El c√≥digo ya existe
                        this.setCustomValidity('Este c√≥digo ya existe');
                        this.classList.add('is-invalid');
                    } else {
                        // El c√≥digo es √∫nico
                        this.setCustomValidity('');
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                })
                .catch(error => {
                    // Error en la consulta, asumir que es v√°lido
                    this.setCustomValidity('');
                    this.classList.remove('is-invalid');
                });
        }
    });
    
    
    console.log('‚úÖ P√°gina de productos inicializada correctamente');
});


</script>
{% endblock %}