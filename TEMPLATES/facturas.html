<!-- templates/facturas.html -->
{% extends "base.html" %}

{% block title %}Facturas - POS Argentina{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-file-invoice"></i> Gestión de Facturas</h1>
    <a href="{{ url_for('nueva_venta') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nueva Venta
    </a>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Número de factura</label>
                <input type="text" class="form-control" id="filtroNumero" placeholder="0001-00000001">
            </div>
            <div class="col-md-3">
                <label class="form-label">Cliente</label>
                <input type="text" class="form-control" id="filtroCliente" placeholder="Nombre del cliente">
            </div>
            <div class="col-md-2">
                <label class="form-label">Estado</label>
                <select class="form-select" id="filtroEstado">
                    <option value="">Todos</option>
                    <option value="autorizada">Autorizada</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="error_afip">Error AFIP</option>
                    <option value="anulada">Anulada</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Fecha desde</label>
                <input type="date" class="form-control" id="fechaDesde">
            </div>
            <div class="col-md-2">
                <label class="form-label">Fecha hasta</label>
                <input type="date" class="form-control" id="fechaHasta">
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12 text-end">
                <button class="btn btn-secondary" onclick="limpiarFiltrosFacturas()">
                    <i class="fas fa-eraser"></i> Limpiar
                </button>
                <button class="btn btn-primary" onclick="aplicarFiltros()">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lista de facturas -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Listado de Facturas</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Número</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Tipo</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>CAE</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for factura in facturas %}
                    <tr>
                        <td><code>{{ factura.numero }}</code></td>
                        <td>{{ factura.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>{{ factura.cliente.nombre }}</td>
                        <td>
                            {% if factura.tipo_comprobante == '01' %}
                                <span class="badge bg-primary">Factura A</span>
                            {% elif factura.tipo_comprobante == '06' %}
                                <span class="badge bg-info">Factura B</span>
                            {% elif factura.tipo_comprobante == '11' %}
                                <span class="badge bg-secondary">Factura C</span>
                            {% else %}
                                <span class="badge bg-dark">{{ factura.tipo_comprobante }}</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <strong>${{ "%.2f"|format(factura.total) }}</strong>
                        </td>
                        <td>
                            {% if factura.estado == 'autorizada' %}
                                <span class="badge bg-success">Autorizada</span>
                            {% elif factura.estado == 'error_afip' %}
                                <span class="badge bg-warning text-dark">Error AFIP</span>
                            {% elif factura.estado == 'anulada' %}
                                <span class="badge bg-danger">Anulada</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ factura.estado.title() }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if factura.cae %}
                                <small><code>{{ factura.cae }}</code></small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('ver_factura', factura_id=factura.id) }}" class="btn btn-info" title="Ver Detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-secondary" onclick="imprimirFactura({{ factura.id }})" title="Imprimir">
                                    <i class="fas fa-print"></i>
                                </button>
                                {% if factura.estado == 'pendiente' %}
                                <button class="btn btn-warning" onclick="reintentarAFIP({{ factura.id }})" title="Reintentar AFIP">
                                    <i class="fas fa-redo"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function imprimirFactura(facturaId) {
    window.open(`/factura/${facturaId}`, '_blank');
}

function reintentarAFIP(facturaId) {
    if (confirm('¿Reintentar autorización en AFIP?')) {
        alert('Función reintentarAFIP en desarrollo. ID: ' + facturaId);
    }
}

function limpiarFiltrosFacturas() {
    document.getElementById('filtroNumero').value = '';
    document.getElementById('filtroCliente').value = '';
    document.getElementById('filtroEstado').value = '';
    document.getElementById('fechaDesde').value = '';
    document.getElementById('fechaHasta').value = '';
}

function aplicarFiltros() {
    // Implementar filtrado
    alert('Función aplicarFiltros en desarrollo');
}
</script>
{% endblock %}